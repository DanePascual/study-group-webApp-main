<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../styles/study-room-inside.css" />
    <title id="pageTitle">Study Room - StudyGroup</title>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <i class="bi bi-book"></i>
          StudyGroup
        </div>
      </div>
      <nav class="sidebar-menu" role="navigation">
        <a href="dashboard.html" class="sidebar-item">
          <i class="bi bi-house"></i>
          <span>Dashboard</span>
        </a>
        <a href="profile.html" class="sidebar-item">
          <i class="bi bi-person"></i>
          <span>Profile</span>
        </a>
        <a href="study-rooms.html" class="sidebar-item active">
          <i class="bi bi-door-open"></i>
          <span>Study Rooms</span>
        </a>
        <a href="resources.html" class="sidebar-item">
          <i class="bi bi-folder"></i>
          <span>Resources</span>
        </a>
        <a href="discussion.html" class="sidebar-item">
          <i class="bi bi-chat-dots"></i>
          <span>Discussion Forum</span>
        </a>
        <a href="report.html" class="sidebar-item">
          <i class="bi bi-flag"></i>
          <span>Report</span>
        </a>
        <!-- Admin Panel Link (only visible to admins) -->
        <a
          href="../../admin/index.html"
          id="adminPanelLink"
          class="sidebar-item admin-item"
          style="display: none"
        >
          <i class="bi bi-shield-check"></i>
          <span>Admin Panel</span>
        </a>
      </nav>
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="sidebarAvatar"></div>
          <div>
            <div style="font-weight: bold; font-size: 14px" id="sidebarName">
              Loading...
            </div>
            <div style="font-size: 12px; opacity: 0.8" id="sidebarCourse">
              Loading...
            </div>
          </div>
        </div>
        <button id="logoutBtn" class="logout-btn">
          <i class="bi bi-box-arrow-right"></i>
          Logout
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
      <!-- Top Navigation -->
      <div class="top-nav">
        <div class="nav-left">
          <button class="menu-toggle" id="menuToggle">
            <i class="bi bi-list"></i>
          </button>
          <h1 class="page-title">
            <i class="bi bi-hash"></i>
            <span id="roomNameDisplay">Loading Room...</span>
            <div class="live-indicator"></div>
          </h1>
        </div>
        <div class="nav-right">
          <button class="theme-toggle" id="themeToggle" title="Toggle theme">
            <i class="bi bi-moon"></i>
          </button>
          <button class="settings-btn" id="settingsBtn" title="Room settings">
            <i class="bi bi-gear"></i>
          </button>
          <button
            class="btn btn-outline-danger btn-sm"
            id="leaveRoomBtn"
            title="Leave this room"
          >
            <i class="bi bi-box-arrow-right"></i> Leave Room
          </button>
          <a href="study-rooms.html" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-box-arrow-left"></i> Back
          </a>
        </div>
      </div>

      <!-- Room Header - Simplified (NO BADGES) -->
      <div class="room-header">
        <div class="room-header-left">
          <div class="room-title">
            <i class="bi bi-people-fill"></i>
            <span id="roomTitleDisplay">Loading Room...</span>
          </div>
        </div>
        <div class="room-header-right">
          <button class="btn btn-sm btn-outline-success" id="inviteBtn">
            <i class="bi bi-person-plus"></i> Invite
          </button>
        </div>
      </div>

      <!-- Main Room Layout -->
      <div class="room-layout">
        <!-- Left Sidebar: Participants -->
        <div class="participants-sidebar">
          <div class="sidebar-header">
            <h5 class="sidebar-title">
              <i class="bi bi-people-fill"></i> Participants
            </h5>
            <span class="participant-count" id="participantCount">1</span>
          </div>
          <div class="participants-list" id="participantsList">
            <!-- JS populates -->
          </div>
        </div>

        <!-- Center: Video Area -->
        <div class="video-main">
          <div class="video-container" id="videoContainer">
            <div class="video-placeholder" id="videoPlaceholder">
              <i class="bi bi-camera-video"></i>
              <p>Click to start video call</p>
              <button class="btn btn-primary btn-lg" id="videoCallBtn">
                <i class="bi bi-camera-video-fill"></i> Start Call
              </button>
            </div>
            <div class="video-grid" id="videoGrid" style="display: none"></div>
          </div>

          <!-- Video Controls Bar -->
          <div
            class="video-controls"
            id="videoControlsBar"
            style="display: none"
          >
            <button
              class="video-control-btn"
              id="toggleMicBtn"
              title="Toggle Microphone (Alt+M)"
            >
              <i class="bi bi-mic-fill"></i>
            </button>
            <button
              class="video-control-btn"
              id="toggleCameraBtn"
              title="Toggle Camera (Alt+V)"
            >
              <i class="bi bi-camera-video-fill"></i>
            </button>
            <button
              class="video-control-btn"
              id="toggleScreenBtn"
              title="Share Screen (Alt+S)"
            >
              <i class="bi bi-share"></i>
            </button>
            <button
              class="video-control-btn btn-danger"
              id="endCallBtn"
              title="End Call (Alt+L)"
            >
              <i class="bi bi-phone-fill"></i> End
            </button>
          </div>
        </div>

        <!-- Right Sidebar: Chat -->
        <div class="chat-sidebar">
          <div class="sidebar-header">
            <h5 class="sidebar-title"><i class="bi bi-chat-dots"></i> Chat</h5>
          </div>

          <!-- Messages -->
          <div class="chat-messages" id="chatMessages">
            <div class="empty-state">
              <i class="bi bi-chat-dots"></i>
              <p>No messages yet</p>
            </div>
          </div>

          <!-- Input -->
          <div class="chat-input-wrapper">
            <div class="chat-input-group">
              <input
                type="text"
                class="chat-input"
                id="messageInput"
                placeholder="Type a message..."
              />
              <button class="chat-btn" id="attachBtn" title="Attach file">
                <i class="bi bi-paperclip"></i>
              </button>
              <button class="chat-btn-send" id="sendMessageBtn">
                <i class="bi bi-send-fill"></i>
              </button>
              <input
                type="file"
                class="file-input"
                id="fileInput"
                accept="image/*,.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx"
              />
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div
      class="modal fade"
      id="settingsModal"
      tabindex="-1"
      aria-labelledby="settingsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <h5 class="modal-title" id="settingsModalLabel">
              <i class="bi bi-gear"></i> Room Settings
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>

          <!-- Modal Body with Tabs -->
          <div class="modal-body">
            <!-- âœ… Tab Navigation -->
            <ul class="nav nav-tabs settings-tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link active settings-tab-btn"
                  id="general-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#general-content"
                  type="button"
                  role="tab"
                  aria-controls="general-content"
                  aria-selected="true"
                >
                  <i class="bi bi-sliders"></i> General
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link settings-tab-btn"
                  id="files-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#files-content"
                  type="button"
                  role="tab"
                  aria-controls="files-content"
                  aria-selected="false"
                >
                  <i class="bi bi-file-earmark"></i> Files
                </button>
              </li>
              <!-- âœ… NEW: Security Tab (Owner + Private Only) -->
              <li
                class="nav-item"
                role="presentation"
                id="security-tab-item"
                style="display: none"
              >
                <button
                  class="nav-link settings-tab-btn"
                  id="security-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#security-content"
                  type="button"
                  role="tab"
                  aria-controls="security-content"
                  aria-selected="false"
                >
                  <i class="bi bi-shield-lock"></i> Security
                </button>
              </li>
            </ul>

            <!-- âœ… Tab Content -->
            <div class="tab-content settings-tab-content">
              <!-- General Tab -->
              <div
                class="tab-pane fade show active"
                id="general-content"
                role="tabpanel"
                aria-labelledby="general-tab"
              >
                <div class="mb-3">
                  <label for="roomNameInput" class="form-label">
                    <i class="bi bi-chat-dots"></i> Room Name
                  </label>
                  <input
                    type="text"
                    class="form-control"
                    id="roomNameInput"
                    placeholder="Enter room name"
                  />
                </div>
                <div class="mb-3">
                  <label for="roomDescInput" class="form-label">
                    <i class="bi bi-file-text"></i> Description
                  </label>
                  <textarea
                    class="form-control"
                    id="roomDescInput"
                    rows="4"
                    placeholder="Enter room description"
                    maxlength="500"
                  ></textarea>
                  <small class="text-muted d-block mt-1">
                    <span id="descCharCount">(0/500)</span>
                  </small>
                </div>
              </div>

              <!-- Files Tab -->
              <div
                class="tab-pane fade"
                id="files-content"
                role="tabpanel"
                aria-labelledby="files-tab"
              >
                <h6 class="mb-3">
                  <i class="bi bi-file-earmark"></i> Shared Files
                </h6>
                <div
                  id="filesList"
                  class="files-list"
                  style="max-height: 400px; overflow-y: auto"
                ></div>
              </div>

              <!-- âœ… NEW: Security Tab -->
              <div
                class="tab-pane fade"
                id="security-content"
                role="tabpanel"
                aria-labelledby="security-tab"
              >
                <!-- âœ… Password Reset Section -->
                <div class="security-section">
                  <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle"></i>
                    <strong>Private Room Protection</strong>
                    <p class="mb-0 mt-2">
                      Reset the password for this private room. All members will
                      need to use the new password to access the room.
                    </p>
                  </div>

                  <div class="password-reset-form">
                    <h6 class="mb-3">
                      <i class="bi bi-lock"></i> Reset Room Password
                    </h6>

                    <div class="mb-3">
                      <label for="newPasswordInput" class="form-label">
                        New Password
                      </label>
                      <input
                        type="password"
                        class="form-control"
                        id="newPasswordInput"
                        placeholder="Enter new password"
                      />
                    </div>

                    <div class="mb-3">
                      <label for="confirmPasswordInput" class="form-label">
                        Confirm Password
                      </label>
                      <input
                        type="password"
                        class="form-control"
                        id="confirmPasswordInput"
                        placeholder="Confirm password"
                      />
                    </div>

                    <!-- âœ… Password Requirements -->
                    <div class="password-strength-box mb-3">
                      <small class="form-text text-muted d-block mb-2">
                        <strong>Password Requirements:</strong>
                      </small>
                      <ul class="password-requirements">
                        <li id="req-length">
                          <i class="bi bi-circle"></i> At least 8 characters
                        </li>
                        <li id="req-upper">
                          <i class="bi bi-circle"></i> One uppercase letter
                          (A-Z)
                        </li>
                        <li id="req-lower">
                          <i class="bi bi-circle"></i> One lowercase letter
                          (a-z)
                        </li>
                        <li id="req-number">
                          <i class="bi bi-circle"></i> One number (0-9)
                        </li>
                      </ul>
                    </div>

                    <!-- âœ… Alert for success/error -->
                    <div
                      id="passwordResetAlert"
                      class="alert"
                      role="alert"
                      style="display: none"
                    ></div>

                    <button
                      type="button"
                      class="btn btn-primary w-100"
                      id="confirmPasswordResetBtn"
                      disabled
                    >
                      <i class="bi bi-check-circle"></i> Reset Password
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-outline-danger"
              id="deleteRoomBtn"
              style="display: none"
            >
              <i class="bi bi-trash"></i> Delete Room
            </button>
            <button type="button" class="btn btn-success" id="saveSettingsBtn">
              <i class="bi bi-check-circle"></i> Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Invite Modal -->
    <div
      class="modal fade"
      id="inviteModal"
      tabindex="-1"
      aria-labelledby="inviteModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="inviteModalLabel">Invite Members</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <label for="inviteLink" class="form-label">Invite Link</label>
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                id="inviteLink"
                readonly
              />
              <button
                class="btn btn-outline-primary"
                type="button"
                id="copyLinkBtn"
              >
                <i class="bi bi-clipboard"></i> Copy
              </button>
            </div>
            <small class="text-muted d-block mt-2"
              >Share this link with others to invite them to the room.</small
            >
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- âœ… NEW: ROOM LOCKED/DEACTIVATED MODAL -->
    <div
      class="modal fade"
      id="roomLockedModal"
      tabindex="-1"
      aria-labelledby="roomLockedLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div
            class="modal-header"
            style="
              background: linear-gradient(135deg, #f44336 0%, #e53935 100%);
              border: none;
            "
          >
            <h5
              class="modal-title"
              id="roomLockedLabel"
              style="
                color: white;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 10px;
              "
            >
              <i class="bi bi-lock-fill"></i> Room Locked
            </h5>
          </div>
          <div class="modal-body" style="text-align: center; padding: 30px">
            <div style="font-size: 48px; margin-bottom: 20px">ðŸ”’</div>
            <h4
              style="
                color: var(--dark-text);
                margin-bottom: 12px;
                font-weight: 600;
              "
            >
              Room Unavailable
            </h4>
            <p
              style="
                color: var(--medium-text);
                line-height: 1.6;
                margin-bottom: 20px;
                font-size: 15px;
              "
            >
              This room has been <strong>locked by an administrator</strong>.
              You cannot interact with this room or send messages.
            </p>
            <p style="color: var(--light-text); font-size: 13px; margin: 0">
              If you believe this is an error, please contact the room creator
              or administrator.
            </p>
          </div>
          <div
            class="modal-footer"
            style="border-top: 1px solid #e0e0e0; padding: 15px 20px"
          >
            <a
              href="study-rooms.html"
              class="btn btn-primary"
              style="background: #4caf50; border-color: #4caf50"
            >
              <i class="bi bi-arrow-left"></i> Back to Study Rooms
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Page Loading -->
    <div id="pageLoadingOverlay" class="loading-overlay" style="display: none">
      <div class="loading-content">
        <div class="spinner-grow text-success"></div>
        <p>Loading study room...</p>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <!-- Firebase Config -->
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAn1-kQypHeeoqZRGYKhJfE5AiICkTX_Hw",
        authDomain: "study-group-webapp-93fc2.firebaseapp.com",
        databaseURL:
          "https://study-group-webapp-93fc2-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "study-group-webapp-93fc2",
        storageBucket: "study-group-webapp-93fc2.firebasestorage.app",
        messagingSenderId: "857690286168",
        appId: "1:857690286168:web:93e5f7bf374b62445a022d",
        measurementId: "G-MR51J9BKM0",
      };
      if (!firebase.apps || !firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      window.firebaseAppInstance = firebase;
    </script>

    <!-- App Modules -->
    <script type="module" src="../scripts/study-group-inside/index.js"></script>
    <script type="module" src="../scripts/sidebar.js"></script>

    <!-- âœ… NEW: Expose window functions for room lock modal -->
    <script type="module">
      import {
        showToast,
        closeToast,
      } from "../scripts/study-group-inside/utils.js";
      window.showToast = showToast;
      window.closeToast = closeToast;
      window.closeRoomLockedModal = function () {
        window.location.href = "study-rooms.html";
      };
    </script>
  </body>
</html>
